name: Test, Build and Deploy to Server

on:
  push:

jobs:
  lint:
    name: Lint Codebase
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15'

      - name: Install Dependencies
        run: npm ci

      - name: Install ESLint
        run: npm install --no-save eslint-formatter-junit

      - name: Run ESLint (JUnit XML)
        run: |
          npx eslint \
            -c .eslintrc.json \
            --ext .js,.jsx,.ts,.tsx \
            src \
            --format junit \
            --output-file eslint-report.xml

      - uses: dorny/test-reporter@v2
        if: always()
        with:
          name: ESLint
          path: eslint-report.xml
          reporter: java-junit

  format:
    name: Check Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15'

      - name: Install Dependencies
        run: npm ci

      - name: Check Prettier
        run: npx prettier --check .

      - name: Generate Prettier JUnit Report
        if: always()
        run: |
          #!/usr/bin/env bash
          set -e

          FILES=$(npx prettier --list-different .)

          printf '<?xml version="1.0" encoding="UTF-8"?>\n<testsuites>\n' > prettier-report.xml

          for f in $FILES; do
            printf '<testsuite name="%s" tests="1" failures="1">\n' "$f" >> prettier-report.xml
            printf '  <testcase classname="Prettier" name="%s">\n' "$f" >> prettier-report.xml
            printf '    <failure message="File is not formatted"/>\n' >> prettier-report.xml
            printf '  </testcase>\n' >> prettier-report.xml
            printf '</testsuite>\n' >> prettier-report.xml
          done

          printf '</testsuites>\n' >> prettier-report.xml

      - name: Publish Prettier Report
        if: always()
        uses: dorny/test-reporter@v2
        with:
          name: Prettier
          path: prettier-report.xml
          reporter: java-junit
          fail-on-error: true


  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [ lint, format ]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15'

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests
        run: npm run test

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [ lint, format ]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15'

      - name: Install Dependencies
        run: npm ci

      - name: Run Cypress E2E Tests
        uses: cypress-io/github-action@v6.9.0
        with:
          start: npm run dev
          wait-on: http://localhost:5173
          wait-on-timeout: 60
          command: npm run e2e:run

  deploy:
    name: Build and Deploy
    needs: [ unit, e2e ]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15'

      - name: Install Dependencies
        run: npm ci

      - name: Build Project
        run: npm run build
      - name: Remove Old Files on Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: "${{ secrets.SSH_HOST }}"
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            find ~/Webserver/WA-DP -mindepth 1 -maxdepth 1 -exec rm -r {} \;

      - name: Transfer New Files
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem
          rsync -avz -e "ssh -i private_key.pem -o StrictHostKeyChecking=no" ./dist/ ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:~/Webserver/WA-DP/
          rm -f private_key.pem
